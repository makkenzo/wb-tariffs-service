# Сервис обновления тарифов Wildberries

## Установка и запуск

**1. Клонируйте репозиторий:**

```bash
git clone https://github.com/makkenzo/wb-tariffs-service.git
cd wb-tariffs-service
```

**2. Настройте переменные окружения:**
Создайте файл `.env` из примера. Вся конфигурация происходит в этом файле.

```bash
cp .env.example .env
```

Откройте файл `.env` и заполните его своими данными:

-   `WB_API_TOKEN`: Ваш токен для доступа к Wildberries API.

-   `GOOGLE_SHEET_IDS`: ID ваших Google-таблиц, перечисленные через запятую (без пробелов). ID можно найти в URL таблицы: `https://docs.google.com/spreadsheets/d/<ID>/edit`.

-   `GOOGLE_CREDENTIALS_BASE64`: Учетные данные сервисного аккаунта Google, закодированные в Base64.

    1.  Получите JSON-файл с ключом сервисного аккаунта из Google Cloud Console.
    2.  **ВАЖНО:** Откройте ваши Google Таблицы и предоставьте права **"Редактора"** email-адресу из этого JSON-файла (поле `client_email`).
    3.  Сконвертируйте содержимое JSON-файла в одну строку Base64. На Linux/macOS:
        ```bash
        base64 -w 0 /путь/к/вашему/credentials.json
        ```
    4.  Вставьте полученную строку в `.env`.

    5.  Запустите приложение:

    ```bash
    docker compose up -d
    ```

### Подробная инструкция по настройке Google API

Для получения `GOOGLE_CREDENTIALS_BASE64` выполните следующие шаги:

**Шаг 1: Настройка в Google Cloud Console**

1.  Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
2.  Создайте новый проект (или выберите существующий).
3.  В строке поиска наверху введите **"Sheets API"** и перейдите на страницу API.
4.  Нажмите кнопку **"Enable"**.

**Шаг 2: Создание Сервисного Аккаунта**

1.  После включения API, нажмите кнопку **"Manage"** -> **"Credentials"**.
2.  Нажмите **"+ Create credentials"** -> **"Service account"**.
3.  Придумайте имя для аккаунта, и нажмите **"Done"**.

**Шаг 3: Получение JSON-ключа**

1.  Перейдите в только что созданный сервисный аккаунт.
2.  Перейдите на вкладку **"Keys"** (Ключи).
3.  Нажмите **"Add key"** -> **"Create new key"**.
4.  Выберите тип ключа **JSON** и нажмите **"Create"**.
5.  На ваш компьютер скачается JSON-файл с учетными данными.

**Шаг 4: Предоставление доступа к Google Таблице**

1.  Откройте скачанный JSON-файл в текстовом редакторе. Найдите и скопируйте значение поля `client_email`.
2.  Откройте вашу Google Таблицу, нажмите на кнопку **"Настройки доступа"** в правом верхнем углу.
3.  Вставьте скопированный email в поле для добавления пользователей и выдайте ему права **"Редактор"**. Нажмите "Отправить".

**Шаг 5: Кодирование ключа в Base64**

1.  Теперь содержимое скачанного JSON-файла нужно преобразовать в одну строку формата Base64. Это необходимо для безопасного хранения многострочного ключа в однострочной переменной окружения `.env`.
2.  Откройте терминал и выполните команду, подставив свой путь к файлу:

    ```bash
    # Для Linux/macOS:
    base64 -w 0 /путь/к/вашему/файлу.json

    # Для Windows не пробовал, но можете попробовать следующий код в PowerShell:
    # [Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\path\to\your\file.json")) | Set-Clipboard
    # Либо использовать Git bash/WSL
    ```

3.  В результате выполнения команды в терминале появится одна длинная строка. Скопируйте её целиком.
4.  Вставьте эту строку в файл `.env` в качестве значения для `GOOGLE_CREDENTIALS_BASE64`.

## Как проверить работу приложения

После запуска приложение один раз выполнит задачу обновления, а затем будет повторять ее каждый час.

**1. Логи приложения:**

```bash
docker compose logs -f wb-tariffs-service
```

**2. База данных:**
Можно подключиться к контейнеру с PostgreSQL и убедиться, что данные на месте.

```bash
docker compose exec db psql -U wbadmin -d db

SELECT * FROM tariffs ORDER BY date DESC, "warehouseName" ASC LIMIT 5;
```

**3. Google Таблицы:**
Откройте вашу Google Таблицу. В ней должен появиться (или обновиться) лист с названием `stocks_coefs`, заполненный актуальными тарифами и отсортированный по возрастанию колонки `boxDeliveryCoefExpr`.
